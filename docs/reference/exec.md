% Copyright 2024 Remy Blank <remy@c-space.org>
% SPDX-License-Identifier: MIT

# Code execution

The {rst:dir}`exec` directive allows executing code directly in the browser.

```{exec} sql
:name: sql-countries
:when: never
:class: hidden
create table countries (
  country text not null,
  country_code text not null,
  dial_code text not null,
  capital text not null,
  population int not null,
  food text
);
insert into countries values
  ('Switzerland', 'CH', '+41', 'Bern', 8776000, 'fondue!'),
  ('France', 'FR', '+33', 'Paris', 67970000, null),
  ('Germany', 'DE', '+49', 'Berlin', 83800000, null),
  ('Italy', 'IT', '+39', 'Rome', 58940000, null),
  ('Austria', 'AT', '+43', 'Vienna', 9042000, 'Kaiserschmarrn'),
  ('Lichtenstein', 'LI', '+423', 'Vaduz', 39327, null);
```

## Directive

````{rst:directive} .. exec:: language (html | python | sql)
This directive is a {rst:dir}`code-block` that allows executing the code
directly in the browser. It supports most of the options of
{rst:dir}`code-block`, and a few more described below.

{.rubric}
Options
```{rst:directive:option} after: name [name...]
Execute one or more {rst:dir}`exec` blocks before this block, in the same
environment.
```
```{rst:directive:option} editor: [ID]
Display the {rst:dir}`exec` block in an editor. If `ID` is provided, the
content of the editor is saved in browser local storage and restored on reload.
`ID` must be unique across all documents, e.g. a
[UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier).
```
```{rst:directive:option} include: path [path...]
:type: relative paths
Prepend the content of one or more files to the block's content.
```
```{rst:directive:option} output-style: property: value; [property: value; ...]
CSS styles to apply to the output generated by the code block, e.g.
`max-height: 10rem`. To which element the styles are applied is
language-specific.
```
```{rst:directive:option} style: property: value; [property: value; ...]
CSS styles to apply to the code block and editor, e.g. `max-height: 20rem`.
```
```{rst:directive:option} then: name [name...]
Execute one or more {rst:dir}`exec` blocks after this block, in the same
environment.
```
```{rst:directive:option} when: value
:type: click | load | never
Determine when the block's code is executed: on user request (`click`, the
default), when the page loads (`load`) or not at all (`never`).
```
````

## Trigger

By default, {rst:dir}`exec` blocks are executed on click
({rst:dir}`:when: click <exec:when>`), with controls displayed next to the
  block.

```{exec} sql
:after: sql-countries
select * from countries where country_code = 'LI';
```

They can also be executed immediately on load
({rst:dir}`:when: load <exec:when>`) or not at all
({rst:dir}`:when: never <exec:when>`), useful for definitions that are
referenced by other blocks). The controls displayed depend on the type of block.

```{exec} sql
:after: sql-countries
:when: load
select * from countries where country_code = 'LI';
```

## Editor

Blocks can be made editable with the {rst:dir}`:editor: <exec:editor>` option.

```{exec} sql
:after: sql-countries
:editor:
select * from countries
  where population > 10000000
  order by country_code;
```

The option takes an optional editor ID. If provided, the content of the editor
is saved in browser local storage, and restored on page reload.

```{exec} sql
:after: sql-countries
:editor: a38c47e0-22fe-4d7a-8c0b-4d38e7d55ee1
```

## Sequencing

The {rst:dir}`:after: <exec:after>` option allows referencing one or more
{rst:dir}`exec` blocks on the same page to be executed before the block, in the
same environment. The referenced blocks can themselves have
{rst:dir}`:after: <exec:after>` options, forming a dependency graph.

Similarly, the {rst:dir}`:then: <exec:then>` option allows referencing one or
more {rst:dir}`exec` blocks to be executed after the block. Unlike
{rst:dir}`:after: <exec:after>`, only the blocks referenced by the
{rst:dir}`:then: <exec:then>` option of the block itself are executed; the
{rst:dir}`:then: <exec:then>` options of referenced blocks are ignored.

If a block appears more than once in the graph, only the first occurrence is
executed.

```{exec} sql
:name: sql-people
:when: never
-- :name: sql-people
create table people (first_name text not null, last_name text not null);
```

```{exec} sql
:name: sql-people-select
:when: never
-- :name: sql-people-select
select * from people;
```

```{exec} sql
:after: sql-people
:then: sql-people-select
:editor:
-- :after: sql-people
-- :then: sql-people-select
insert into people values ('Joe', 'Bar'), ('Jack', 'Sparrow');
```

## Include file content

The {rst:dir}`:include: <exec:include>` option allows including the content of
one or more external files. The content of the files is prepended to the block's
content.

```{exec} sql
:include: people.sql
select * from people;
```

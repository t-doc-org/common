<!-- Copyright 2024 Remy Blank <remy@c-space.org> -->
<!-- SPDX-License-Identifier: MIT -->

# Python

The `{exec} python` block allows executing Python code directly in the browser.

```{exec} python
:when: load
:class: hidden
import platform
print(f"{platform.python_implementation()} {'.'.join(platform.python_version_tuple())}"
      f" on {platform.platform()}")
```

## Module setup

Module setup code can be defined as a named `{exec} python` block, to be
referenced in the `:after:` option of other blocks.

```{exec} python
:name: python-setup
:when: never
:linenos:
def factorial(n):
  res = 1
  for i in range(2, n + 1):
    res *= i
  return res
```

## Program output

### Terminal

The terminal output generated by an `{exec} python` block via `sys.stdout` and
`sys.stderr` (and therefore, via `print()`) is displayed in an output block.
Output to `sys.stderr` is colored.

```{exec} python
:after: python-setup
:editable:
for i in range(10):
  print(f"factorial({i}) = {factorial(i)}")

import sys
sys.stderr.write("Program terminated.\n")
```

The terminal output block can be cleared with the form-feed control character
(`\x0c`).

```{exec} python
:when: click
:editable:
import asyncio

for i in range(10, 0, -1):
  print(f"\x0c{i}...")
  await asyncio.sleep(1)
print("\x0cHappy new year!")
```

### Graphics

The
[`tdoc.svg`](https://github.com/t-doc-org/common/blob/main/tdoc/common/python/svg.py)
module allows creating SVG images using simple drawing primitives. Rendering an
image creates an output block displaying the image.

`render(image, name='')`

- `image`: The image to be rendered.
- `name`: The name of the output block. If a block with the same name already
  exists, it is replaced. Otherwise, a new block is added, keeping blocks
  ordered by name.

```{exec} python
:name: python-graphics
:when: load
:editable:
from tdoc import svg

def paint_heart(img, x, y, angle, scale=0.5):
  img.path('M -40,-20 A 20,20 0,0,1 0,-20 A 20,20 0,0,1 40,-20 '
           'Q 40,10 0,40 Q -40,10 -40,-20 z', fill='transparent',
           transform=svg.translate(x=x, y=y).rotate(angle).scale(scale))

img = svg.Image(400, 100, stroke='red', fill='#c0c0ff',
                style='width: 100%; height: 100%')
img.circle(20, 30, 10)
img.ellipse(20, 70, 10, 20)
img.line(0, 0, 400, 100)
img.polygon((250, 10), (280, 10), (290, 30))
img.polyline((250, 10), (280, 10), (290, 30), fill='transparent',
             transform=svg.translate(x=40, y=10))
img.rect(0, 0, 400, 100, fill='transparent')
img.text(50, 90, "Some text", fill='green')
paint_heart(img, 370, 30, 20)
render(img)
```

Animations can be implemented by rendering images repeatedly in a loop, with
a short sleep between images. **Don't forget to sleep**, otherwise the program
becomes unstoppable and the page must be reloaded.

```{exec} python
:after: python-graphics
:when: load
:editable:
import asyncio

x, y, angle = 200, 50, 0.0
step_x, step_y, step_angle = 1.7, 1.3, 3.0
margin = 20

while True:
  img = svg.Image(400, 100, stroke='red', style='width: 100%; height: 100%')
  paint_heart(img, x, y, angle)
  render(img)

  x += step_x
  if x < margin or x > img.width - margin: step_x = -step_x
  y += step_y
  if y < margin or y > img.height - margin: step_y = -step_y
  angle = (angle + step_angle) % 360.0

  await asyncio.sleep(1 / 60)
```

## Program input

User input can be requested by `await`ing functions available in the global
environment. Unfortunately, `sys.stdin` (and anything that depends on it) cannot
be used, due to its blocking nature.

### Line of text

`await input_line(prompt=None)`

- `prompt`: The text to display before the input field.
- Returns the content of the input field as a `str`.

```{exec} python
:when: load
:editable:
name = await input_line("What is your name?")
print(f"Hello, {name}!")
```

### Multi-line text

`await input_text(prompt=None)`

- `prompt`: The text to display before the input field.
- Returns the content of the input field as a `str`.

```{exec} python
:when: load
:editable:
print("Please enter some text.")
text = await input_text()
print(f"\x0cThe text was:\n-------------\n{text}")
```

### Buttons

`await input_buttons(prompt, labels)`

- `prompt`: The text to display before the buttons, or `None` to not display a
  prompt.
- `labels`: The labels of the buttons, as a `list`.
- Returns the index of the button that was clicked, as an `int`.

```{exec} python
:when: load
:editable:
colors = ["Red", "Green", "Blue"]
index = await input_buttons("Pick a color:", colors)
print(f"You picked: {colors[index]}")
```

### Pause

`await pause(prompt=None, label="@icon{forward-step}")`

- `prompt`: The text to display before the button, or `None` to not display a
  prompt.
- `label`: The label of the button. If the label has the format `@icon{...}`,
  the corresponding icon from
  [Font Awesome](https://fontawesome.com/icons/categories) is used.

```{exec} python
:when: load
:editable:

n = 5
fact = 1
for i in range(2, n + 1):
  fact *= i
  await pause(f"i={i}, fact={fact}")
print(f"The factorial of {n} is {fact}")
```

## Exceptions

Exceptions that propagate out of the `{exec} python` block are displayed as a
traceback on `sys.stderr`.

```{exec} python
:after: python-setup
:editable:
def outer():
  try:
    inner()
  except Exception as e:
    raise Exception("inner() failed") from e

def inner():
  raise Exception("Something is broken")

outer()
```

## Concurrency

All `{exec} python` blocks on a page are executed in a shared, single-threaded
interpreter. Therefore, only one block can run at any given time. Nevertheless,
concurrent execution is possible through `async` coroutines. The
[`asyncio`](https://docs.python.org/3/library/asyncio.html) module provides a
lot of functionality related to `async` concurrency.

```{exec} python
:when: load
:editable:
import asyncio
import time

while True:
  print(f"\x0c{time.strftime('%Y-%m-%d %H:%M:%S')}")
  await asyncio.sleep(1)
```

```{exec} python
:when: load
:editable:
import asyncio

i = 0
while True:
  print(f"\x0ci={i}")
  i += 1
  await asyncio.sleep(0.2)
```
